-- ลบข้อมูลทั้งหมดในตาราง appointments
DELETE FROM appointments;

-- รีเซ็ต AUTO_INCREMENT ให้เริ่มที่ 1
ALTER TABLE appointments AUTO_INCREMENT = 1;



-- ลบข้อมูลทั้งหมดในตาราง users
DELETE FROM users;

-- รีเซ็ต AUTO_INCREMENT ให้เริ่มที่ 1
ALTER TABLE users AUTO_INCREMENT = 1;



รายงานการนัดหมาย เป็น ปฎิทิน ตามช่วงเวลา 
เช่น จาก ต้นเดือน-สิ้นเดือน หรือ สามารถเลือกได้หมด ตามช่วงเวลา





zkdm crun dwtj nrfv  
anumas.s@rmutp.ac.th



<?php
session_start();
require 'db.php';
require 'vendor/autoload.php'; // โหลด Composer สำหรับ domPDF

// ตรวจสอบว่าเป็นผู้ใช้ที่มีสิทธิ์หรือไม่
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'teacher') {
    header('Location: login.php');
    exit;
}

// รับค่าช่วงวันที่จาก URL
$start_date = isset($_GET['start_date']) ? $_GET['start_date'] : date('Y-m-01');
$end_date = isset($_GET['end_date']) ? $_GET['end_date'] : date('Y-m-t');

// ตรวจสอบการเชื่อมต่อ
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

// คิวรีข้อมูลการนัดหมาย
$query = "SELECT 
            students.username AS student_name, 
            teachers.username AS teacher_name, 
            appointments.appointment_date, 
            appointments.appointment_time, 
            appointments.status 
          FROM appointments 
          JOIN users AS students ON appointments.student_id = students.id 
          JOIN users AS teachers ON appointments.teacher_id = teachers.id 
          WHERE appointments.appointment_date BETWEEN ? AND ? 
          ORDER BY appointments.appointment_date, appointments.appointment_time";

$stmt = $conn->prepare($query);

if (!$stmt) {
    die("Query preparation failed: " . $conn->error);
}

$stmt->bind_param("ss", $start_date, $end_date);
$stmt->execute();
$result = $stmt->get_result();
$appointments = $result->fetch_all(MYSQLI_ASSOC);

// ตรวจสอบว่ามีข้อมูลหรือไม่
if (!$appointments) {
    die("ไม่พบข้อมูลการนัดหมายในช่วงวันที่เลือก");
}

// เริ่มต้น PDF
$options = new \Dompdf\Options();
$options->set('isHtml5ParserEnabled', true);
$options->set('isPhpEnabled', true);

// ตั้งค่า fontDir ไปที่ที่เก็บฟอนต์
$options->set('fontDir', __DIR__ . '/fonts'); // เส้นทางที่เก็บฟอนต์
$options->set('fontCache', __DIR__ . '/font_cache'); // เส้นทางเก็บแคชฟอนต์
$options->set('defaultFont', 'THSarabunNew');  // ใช้ฟอนต์ THSarabunNew ที่รองรับภาษาไทย

$dompdf = new \Dompdf\Dompdf($options);

// ใส่ HTML ใน PDF
$html = '<h2 style="text-align:center; font-family: THSarabunNew;">สรุปรายงานการนัดหมาย</h2>';
$html .= '<p style="text-align:center; font-family: THSarabunNew;">ช่วงวันที่ ' . htmlspecialchars($start_date) . ' ถึง ' . htmlspecialchars($end_date) . '</p>';
$html .= '<table border="1" width="100%" cellpadding="5" cellspacing="0">
            <thead>
                <tr>
                    <th style="font-family: THSarabunNew;">ชื่อนักศึกษา</th>
                    <th style="font-family: THSarabunNew;">อาจารย์</th>
                    <th style="font-family: THSarabunNew;">วันที่</th>
                    <th style="font-family: THSarabunNew;">เวลา</th>
                    <th style="font-family: THSarabunNew;">สถานะ</th>
                </tr>
            </thead>
            <tbody>';

foreach ($appointments as $appointment) {
    $html .= '<tr>
                <td style="font-family: THSarabunNew;">' . htmlspecialchars($appointment['student_name']) . '</td>
                <td style="font-family: THSarabunNew;">' . htmlspecialchars($appointment['teacher_name']) . '</td>
                <td style="font-family: THSarabunNew;">' . htmlspecialchars($appointment['appointment_date']) . '</td>
                <td style="font-family: THSarabunNew;">' . htmlspecialchars($appointment['appointment_time']) . '</td>
                <td style="font-family: THSarabunNew;">' . htmlspecialchars($appointment['status']) . '</td>
              </tr>';
}

$html .= '</tbody></table>';

// ใส่ HTML เข้า PDF
$dompdf->loadHtml($html);
$dompdf->setPaper('A4', 'portrait');
$dompdf->render();

// แสดง PDF ใน browser
$dompdf->stream("report.pdf", array("Attachment" => 0));

exit;

$filePath = __DIR__ . '/fpdf186/tutorial/logo.png';  // ใช้ __DIR__ เพื่อให้ได้เส้นทางของโฟลเดอร์ปัจจุบัน

  <?php
require_once('vendor/autoload.php');  // Composer autoload

use setasign\Fpdi\Fpdi;

$filePath = __DIR__ . '/fpdf186/tutorial/logo.png';  // ใช้ __DIR__ เพื่อให้ได้เส้นทางของโฟลเดอร์ปัจจุบัน

// เชื่อมต่อกับฐานข้อมูล
require 'db.php';
session_start();

// ตรวจสอบสิทธิ์ผู้ใช้
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'teacher') {
    header('Location: login.php');
    exit;
}

// รับค่าช่วงวันที่จาก URL
$start_date = isset($_GET['start_date']) ? $_GET['start_date'] : date('Y-m-01');
$end_date = isset($_GET['end_date']) ? $_GET['end_date'] : date('Y-m-t');

// ตรวจสอบการเชื่อมต่อฐานข้อมูล
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

// ดึงข้อมูลจากฐานข้อมูล
$query = "SELECT 
            students.username AS student_name, 
            teachers.username AS teacher_name, 
            appointments.appointment_date, 
            appointments.appointment_time, 
            appointments.status 
          FROM appointments 
          JOIN users AS students ON appointments.student_id = students.id 
          JOIN users AS teachers ON appointments.teacher_id = teachers.id 
          WHERE appointments.appointment_date BETWEEN ? AND ? 
          ORDER BY appointments.appointment_date, appointments.appointment_time";

$stmt = $conn->prepare($query);
$stmt->bind_param("ss", $start_date, $end_date);
$stmt->execute();
$result = $stmt->get_result();
$appointments = $result->fetch_all(MYSQLI_ASSOC);

// ตรวจสอบว่ามีข้อมูลหรือไม่
if (!$appointments) {
    die("ไม่พบข้อมูลการนัดหมายในช่วงวันที่เลือก");
}

class PDF extends Fpdi {
    function Header() {
        $this->Image($GLOBALS['filePath'], 10, 6, 30); // ใส่โลโก้
        $this->SetFont('Arial', 'B', 16);
        $this->Cell(80);
        $this->Cell(30, 10, iconv('UTF-8', 'TIS-620', 'รายงานการนัดหมาย'), 0, 1, 'C');
        $this->Ln(5);
    }

    function Footer() {
        $this->SetY(-15);
        $this->SetFont('Arial', 'I', 8);
        $this->Cell(0, 10, 'Page ' . $this->PageNo() . '/{nb}', 0, 0, 'C');
    }
}

// สร้าง PDF
$pdf = new PDF();
$pdf->AliasNbPages();
$pdf->AddPage();
$pdf->SetFont('THSarabunNew', '', 12);

// แสดงวันที่
$pdf->Cell(0, 10, iconv('UTF-8', 'TIS-620', 'ช่วงวันที่ ' . $start_date . ' ถึง ' . $end_date), 0, 1, 'C');
$pdf->Ln(5);

// สร้างตารางหัวข้อ
$pdf->SetFillColor(200, 220, 255);
$pdf->Cell(50, 10, iconv('UTF-8', 'TIS-620', 'ชื่อนักศึกษา'), 1, 0, 'C', true);
$pdf->Cell(50, 10, iconv('UTF-8', 'TIS-620', 'อาจารย์'), 1, 0, 'C', true);
$pdf->Cell(30, 10, iconv('UTF-8', 'TIS-620', 'วันที่'), 1, 0, 'C', true);
$pdf->Cell(30, 10, iconv('UTF-8', 'TIS-620', 'เวลา'), 1, 0, 'C', true);
$pdf->Cell(30, 10, iconv('UTF-8', 'TIS-620', 'สถานะ'), 1, 1, 'C', true);

// เพิ่มข้อมูลในตาราง
foreach ($appointments as $appointment) {
    $pdf->Cell(50, 10, iconv('UTF-8', 'TIS-620', $appointment['student_name']), 1, 0, 'C');
    $pdf->Cell(50, 10, iconv('UTF-8', 'TIS-620', $appointment['teacher_name']), 1, 0, 'C');
    $pdf->Cell(30, 10, iconv('UTF-8', 'TIS-620', $appointment['appointment_date']), 1, 0, 'C');
    $pdf->Cell(30, 10, iconv('UTF-8', 'TIS-620', $appointment['appointment_time']), 1, 0, 'C');
    $pdf->Cell(30, 10, iconv('UTF-8', 'TIS-620', $appointment['status']), 1, 1, 'C');
}

// แสดง PDF ใน Browser
$pdf->Output();
?>
